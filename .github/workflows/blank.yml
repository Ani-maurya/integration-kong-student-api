---
name: Kong API Gateway Workflow
on:
  push:
    branches:
      - main
jobs:
  OAS_TO_Kong:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Check head on main or not
        run: |
        if: github.ref == 'refs/heads/main'

      - name: download jq
        run: |
          sudo apt install jq -y
          jq --version

      - name: download yq
        run: |
          sudo snap install yq
          yq --version

      - name: Install deck CLI
        run: >
          curl -sL
          https://github.com/kong/deck/releases/download/v1.34.0/deck_1.34.0_linux_amd64.tar.gz
          -o deck.tar.gz

          tar -xf deck.tar.gz -C /tmp 

          sudo cp /tmp/deck /usr/local/bin/

          deck file openapi2kong -s test.yaml --select-tag=dev -o kong.yaml

      - name: Append Plugins to new-api.yaml
        run: >
          if [ "${{ vars.KEY_AUTH }}" == "true" ] || [ "${{ vars.RATE_LIMITING }}" ==
          "true" ] || [ "${{ vars.REQUEST_SIZE_LIMITING }}" == "true" ] || [
          "${{ vars.HTTP_LOG }}" == "true" ] || [ "${{ vars.IP_RESTRICTION }}" ==
          "true" ] || [ "${{ vars.ACL }}" == "true" ] || [
          "${{ vars.OAS_VALIDATION }}" == "true" ] || [ "${{ vars.OPENID_CONNECT }}" ==
          "true" ] || [ "${{ vars.CORRELATION_ID }}" ==
          "true" ]; then
             sed -i '1,2d' ratelimiting.yaml acl.yaml http-log.yaml request-size-limiting.yaml ip-restriction.yaml oas-validation.yaml correlation.yaml open-id.yaml
             sed -i '1d' keyauth.yaml
             cat keyauth.yaml ratelimiting.yaml request-size-limiting.yaml acl.yaml http-log.yaml  ip-restriction.yaml oas-validation.yaml correlation.yaml open-id.yaml > combined-plugins.yaml
             cat combined-plugins.yaml
             export plugins=$(cat combined-plugins.yaml)
             echo $plugins
             cat kong.yaml | yq '.services.[] += env(plugins)' -o yaml > modified-api.yaml
             # cat new-api.yaml | yq '.services.[] += env(plugins)' -o yaml > modified-api.yaml
          fi

      - name: Set headers and run deck sync
        run: >
          cat modified-api.yaml
          
          # deck file openapi2kong -s test.yaml --select-tag=dev -o kong.yaml

          deck gateway sync  --select-tag dev modified-api.yaml --konnect-token ${{ secrets.DECK_TOKEN }} --konnect-control-plane-name ${{ vars.DECK_CONTROL_PLANE_NAME }}
          
  publish-customer-api-to-portal:
    name: Publish OAS to dev portal
    needs: OAS_TO_Kong
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Fech environment variables
        id: set_env_vars
        run: |
          echo "API_PRODUCT_NAME: ${{ vars.API_PRODUCT_NAME }}"
          echo "CONTROL_PLANE_NAME: ${{ vars.CONTROL_PLANE_NAME }}" 
          echo "GATEWAY_SERVICE_NAME: ${{ vars.GATEWAY_SERVICE_NAME }}" 

      - name: Create API product
        run: |
          curl --request POST \
            --url https://us.api.konghq.com/v2/api-products \
            --header 'Authorization: ${{ secrets.PIPELINE_TOKEN }}' \
            --header 'Content-Type: application/json' \
            --data '{
              "name": "${{ vars.API_PRODUCT_NAME }}",
              "description": "Creating through admin api",
              "labels": {}
            }' 

      - name: Get API product ID
        run: >
          api_product_name="${{ vars.API_PRODUCT_NAME }}"

          api_product_id=$(curl --request GET \
            --url https://us.api.konghq.com/v2/api-products \
            --header 'Authorization: ${{ secrets.PIPELINE_TOKEN }}' \
            | jq -r --arg api_product_name "$api_product_name" '.data[] | select(.name == $api_product_name) | .id // empty')

          if [ "$api_product_id" = "empty" ]; then
            echo "Error: API Product ID not found."
            exit 1
          fi

          echo "API_PRODUCT_ID=$api_product_id" >> $GITHUB_ENV 

      - name: Get Dev Portal ID
        run: |
          Dev_portal_id=$(curl --request GET \
            --url https://us.api.konghq.com/v2/portals \
            --header 'Authorization: ${{ secrets.PIPELINE_TOKEN }}' \
            | jq -r '.data[].id')
              echo "DEV_PORTAL_ID=$Dev_portal_id" >> $GITHUB_ENV

      - name: Publish product to the dev portal
        run: |
          echo "API Product ID: $API_PRODUCT_ID"
          echo "Dev Portal ID: $DEV_PORTAL_ID"
          curl --request PATCH \
           --url https://us.api.konghq.com/v2/api-products/$API_PRODUCT_ID \
           --header 'Authorization: ${{ secrets.PIPELINE_TOKEN }}' \
           --header 'Content-Type: application/json' \
           --data "{
             \"portal_ids\":[\"$DEV_PORTAL_ID\"]
           }"

      - name: Create the product version
        run: >
          echo "API Product ID: $API_PRODUCT_ID"

          api_product_version_id=$(curl --request POST \
            --url https://us.api.konghq.com/v2/api-products/$API_PRODUCT_ID/product-versions \
            --header 'Authorization: ${{ secrets.PIPELINE_TOKEN }}' \
            --header 'Content-Type: application/json' \
            --data '{
              "name": "v1",
              "publish_status": "published",
              "gateway_service": null
            }'| jq -r '.id')
              echo "API_Product_Version_ID=$api_product_version_id" >> $GITHUB_ENV
              echo "API Product Version ID: $API_Product_Version_ID"

      - name: Get Control Plane ID
        run: >
          control_plane_name="${{ vars.CONTROL_PLANE_NAME }}"

          control_plane_id=$(curl --location 'https://us.api.konghq.com/v2/control-planes' \

          --header 'Authorization: ${{ secrets.PIPELINE_TOKEN }}' \

          | jq -r --arg control_plane_name "$control_plane_name" '.data[] | select(.name == $control_plane_name) | .id')

          echo "Control_Plane_ID=$control_plane_id" >> $GITHUB_ENV

      - name: Get Service ID
        run: >
          echo "Control Plane Id: $Control_Plane_ID"

          gateway_service_name="${{ vars.GATEWAY_SERVICE_NAME }}"

          service_id=$(curl --location "https://us.api.konghq.com/v2/control-planes/$Control_Plane_ID/core-entities/services" \
            --header 'Authorization: ${{ secrets.PIPELINE_TOKEN }}' \
            | jq -r --arg gateway_service_name "$gateway_service_name" '.data[] | select(.name == $gateway_service_name) | .id')
          echo "Service_ID=$service_id" >> $GITHUB_ENV

      - name: Link service to the product version
        run: >
          echo "API PRODUCT ID: $API_PRODUCT_ID"

          echo "Control Plane ID: $Control_Plane_ID"

          echo "Service ID: $Service_ID"

          echo "API Product Version ID: $API_Product_Version_ID"

          curl --location --request PATCH "https://us.api.konghq.com/v2/api-products/$API_PRODUCT_ID/product-versions/$API_Product_Version_ID" \
                --header 'Authorization: ${{ secrets.PIPELINE_TOKEN }}' \
                --header 'Content-Type: application/json' \
                --data "{
                        \"name\": \"v1\",
                        \"publish_status\": \"published\",
                        \"deprecated\": false,
                        \"notify\": true,
                        \"gateway_service\": {
                        \"control_plane_id\": \"$Control_Plane_ID\",
                        \"id\": \"$Service_ID\"
                                }
                       }"

      - name: Upload spec on the version
        run: |
          echo "API PRODUCT ID: $API_PRODUCT_ID"
          echo "API Product Version ID: $API_Product_Version_ID"
          encoded_spec=$(base64 student.yaml)
          echo $encoded_spec
          # echo $spec
          curl --location --request POST "https://us.api.konghq.com/v2/api-products/$API_PRODUCT_ID/product-versions/$API_Product_Version_ID/specifications" \
            --header "Authorization: \$\{{ secrets.PIPELINE_TOKEN \}\}" \
            --header "Content-Type: application/json" \
            --data "{
                    "name": "student.yaml", 
                    "content": "b3BlbmFwaTogMy4wLjAKaW5mbzoKICB0aXRsZTogU3R1ZGVudCBJbmZvcm1hdGlvbiBBUEkKICBkZXNjcmlwdGlvbjogIiMjIFN0dWRlbnQgaW5mb3JtYXRpb24gQVBJICIKICBjb250YWN0OgogICAgZW1haWw6IGludGVncmF0aW9udGVhbUBzaGVmZmllbGQuYWMudWsKICB2ZXJzaW9uOiAwLjAuMQpzZXJ2ZXJzOgogIC0gdXJsOiBodHRwczovL2FwaS5leGFtcGxlLmNvbS92MQp0YWdzOgogIC0gbmFtZTogR2V0U3R1ZGVudHMKICAgIGRlc2NyaXB0aW9uOiBHZXQgU3R1ZGVudHMgSW5mb3JtYXRpb24KcGF0aHM6CiAgL3N0dWRlbnRzOgogICAgZ2V0OgogICAgICB0YWdzOgogICAgICAgIC0gR2V0U3R1ZGVudHMKICAgICAgc3VtbWFyeTogUmV0cmlldmUgc3R1ZGVudCBpbmZvcm1hdGlvbgogICAgICBkZXNjcmlwdGlvbjogUmV0dXJucyBhIGxpc3Qgb2Ygc3R1ZGVudCBpbmZvcm1hdGlvbi4KICAgICAgb3BlcmF0aW9uSWQ6IGdldFN0dWRlbnRzCiAgICAgIHBhcmFtZXRlcnM6CiAgICAgICAgLSAkcmVmOiAiIy9jb21wb25lbnRzL3BhcmFtZXRlcnMvQXV0aG9yaXphdGlvbkhlYWRlciIKICAgICAgICAtICRyZWY6ICIjL2NvbXBvbmVudHMvcGFyYW1ldGVycy9Db250ZW50VHlwZUhlYWRlciIKICAgICAgICAtICRyZWY6ICIjL2NvbXBvbmVudHMvcGFyYW1ldGVycy9Db3JyZWxhdGlvbklkSGVhZGVyIgogICAgICAgIC0gJHJlZjogIiMvY29tcG9uZW50cy9wYXJhbWV0ZXJzL1JlcXVlc3RJZEhlYWRlciIKICAgICAgICAtICRyZWY6ICIjL2NvbXBvbmVudHMvcGFyYW1ldGVycy9UaW1lc3RhbXBIZWFkZXIiCiAgICAgICAgLSAkcmVmOiAiIy9jb21wb25lbnRzL3BhcmFtZXRlcnMvVGVzdEhlYWRlciIKICAgICAgICAtIG5hbWU6IHN0dWRlbnRDb2RlCiAgICAgICAgICBpbjogcXVlcnkKICAgICAgICAgIGRlc2NyaXB0aW9uOiBGaWVsZHMgdG8gaW5jbHVkZSBpbiB0aGUgcmVzcG9uc2UKICAgICAgICAgIHJlcXVpcmVkOiB0cnVlCiAgICAgICAgICBzY2hlbWE6CiAgICAgICAgICAgIHR5cGU6IHN0cmluZwogICAgICAgICAgZXhhbXBsZTogc3VybmFtZSxlbnJvbGxtZW50LnByb2dyYW1tZSwgcHJvZ3JhbW1lCiAgICAgICAgLSBuYW1lOiByZWdpc3RyYXRpb25OdW1iZXIKICAgICAgICAgIGluOiBxdWVyeQogICAgICAgICAgZGVzY3JpcHRpb246IFN0dWRlbnQgcmVnaXN0cmF0aW9uIG51bWJlcgogICAgICAgICAgcmVxdWlyZWQ6IHRydWUKICAgICAgICAgIHNjaGVtYToKICAgICAgICAgICAgdHlwZTogc3RyaW5nCiAgICAgICAgICBleGFtcGxlOiAxMTIyCiAgICAgICAgLSBuYW1lOiByZWdpc3RyYXRpb25TdGF0dXMKICAgICAgICAgIGluOiBxdWVyeQogICAgICAgICAgZGVzY3JpcHRpb246IHN0dWRlbnQgcmVnaXN0cmF0aW9uIHN0YXR1cwogICAgICAgICAgcmVxdWlyZWQ6IHRydWUKICAgICAgICAgIHNjaGVtYToKICAgICAgICAgICAgdHlwZTogc3RyaW5nCiAgICAgICAgICBleGFtcGxlOiBhY3RpdmUKICAgICAgICAtIG5hbWU6IGZpZWxkcwogICAgICAgICAgaW46IHF1ZXJ5CiAgICAgICAgICBkZXNjcmlwdGlvbjogRmllbGRzIHRvIGluY2x1ZGUgaW4gdGhlIHJlc3BvbnNlLCBjdXJyZW50bHkgbm90IHVzZWQuCiAgICAgICAgICByZXF1aXJlZDogZmFsc2UKICAgICAgICAgIHNjaGVtYToKICAgICAgICAgICAgdHlwZTogc3RyaW5nCiAgICAgICAgICBleGFtcGxlOiBzdXJuYW1lLGVucm9sbG1lbnQucHJvZ3JhbW1lLCBwcm9ncmFtbWUKICAgICAgcmVzcG9uc2VzOgogICAgICAgICIyMDAiOgogICAgICAgICAgZGVzY3JpcHRpb246IEEgbGlzdCBvZiBzdHVkZW50IGluZm9ybWF0aW9uLgogICAgICAgICAgY29udGVudDoKICAgICAgICAgICAgYXBwbGljYXRpb24vanNvbjoKICAgICAgICAgICAgICBzY2hlbWE6CiAgICAgICAgICAgICAgICB0eXBlOiBhcnJheQogICAgICAgICAgICAgICAgaXRlbXM6CiAgICAgICAgICAgICAgICAgICRyZWY6ICIjL2NvbXBvbmVudHMvc2NoZW1hcy9TdHVkZW50IgogICAgICAgICI0MDAiOgogICAgICAgICAgZGVzY3JpcHRpb246IEJhZCByZXF1ZXN0CiAgICAgICAgICBjb250ZW50OgogICAgICAgICAgICBhcHBsaWNhdGlvbi9qc29uOgogICAgICAgICAgICAgIHNjaGVtYToKICAgICAgICAgICAgICAgICRyZWY6ICIjL2NvbXBvbmVudHMvc2NoZW1hcy9FcnJvcjQwMCIKICAgICAgICAiNDAxIjoKICAgICAgICAgIGRlc2NyaXB0aW9uOiBVbmF1dGhvcml6ZWQKICAgICAgICAgIGNvbnRlbnQ6CiAgICAgICAgICAgIGFwcGxpY2F0aW9uL2pzb246CiAgICAgICAgICAgICAgc2NoZW1hOgogICAgICAgICAgICAgICAgJHJlZjogIiMvY29tcG9uZW50cy9zY2hlbWFzL0Vycm9yNDAxIgogICAgICAgICI0MDMiOgogICAgICAgICAgZGVzY3JpcHRpb246IEZvcmJpZGRlbgogICAgICAgICAgY29udGVudDoKICAgICAgICAgICAgYXBwbGljYXRpb24vanNvbjoKICAgICAgICAgICAgICBzY2hlbWE6CiAgICAgICAgICAgICAgICAkcmVmOiAiIy9jb21wb25lbnRzL3NjaGVtYXMvRXJyb3I0MDMiCiAgICAgICAgIjUwMCI6CiAgICAgICAgICBkZXNjcmlwdGlvbjogSW50ZXJuYWwgU2VydmVyIEVycm9yCiAgICAgICAgICBjb250ZW50OgogICAgICAgICAgICBhcHBsaWNhdGlvbi9qc29uOgogICAgICAgICAgICAgIHNjaGVtYToKICAgICAgICAgICAgICAgICRyZWY6ICIjL2NvbXBvbmVudHMvc2NoZW1hcy9FcnJvcjUwMCIKICAgICAgc2VjdXJpdHk6CiAgICAgICAgLSBiZWFyZXJBdXRoOgogICAgICAgICAgICAtIHVvcy9zdHVkZW50LXJlYWQKICAgICAgICAgICAgLSB1b3Mvc3R1ZGVudC1yZWFkLWFsbAogICAgICAgIC0gYXBpS2V5OiBbXQpjb21wb25lbnRzOgogIHNjaGVtYXM6CiAgICBTdHVkZW50OgogICAgICB0eXBlOiBvYmplY3QKICAgICAgcHJvcGVydGllczoKICAgICAgICB0aXRsZToKICAgICAgICAgIHR5cGU6IGludGVnZXIKICAgICAgICAgIGRlc2NyaXB0aW9uOiBUaGUgc3R1ZGVudCdzIElELgogICAgICAgICAgZXhhbXBsZTogMTIzCiAgICAgICAgZm9yZW5hbWU6CiAgICAgICAgICB0eXBlOiBzdHJpbmcKICAgICAgICAgIGRlc2NyaXB0aW9uOiBUaGUgc3R1ZGVudCdzIGZvcmVuYW1lLgogICAgICAgICAgZXhhbXBsZTogQWxpY2UKICAgICAgICBrbm93bmFzOgogICAgICAgICAgdHlwZTogc3RyaW5nCiAgICAgICAgICBkZXNjcmlwdGlvbjogVGhlIHN0dWRlbnQncyBrbm93bmFzIG5hbWUuCiAgICAgICAgICBleGFtcGxlOiBKb2huCiAgICAgICAgbGFzdG5hbWU6CiAgICAgICAgICB0eXBlOiBzdHJpbmcKICAgICAgICAgIGRlc2NyaXB0aW9uOiBUaGUgc3R1ZGVudCdzIGtub3duYXMgbmFtZS4KICAgICAgICAgIGV4YW1wbGU6IEpvaG4KICAgICAgICB1bml2ZXJzaXR5RW1haWw6CiAgICAgICAgICB0eXBlOiBzdHJpbmcKICAgICAgICAgIGZvcm1hdDogZW1haWwKICAgICAgICAgIGRlc2NyaXB0aW9uOiBUaGUgc3R1ZGVudCdzIHVuaXZlcnNpdHkgZW1haWwuCiAgICAgICAgICBleGFtcGxlOiBhbGljZS5zbWl0aEB1bml2ZXJzaXR5LmVkdQogICAgICAgIHJ2RG9tYWluOgogICAgICAgICAgdHlwZTogc3RyaW5nCiAgICAgICAgICBkZXNjcmlwdGlvbjogVGhlIHN0dWRlbnQncyBkb21haW4uCiAgICAgICAgICBleGFtcGxlOiBSRUdfU1RBVFVTX0dSUF9BVFQKICAgIEVycm9yNDAwOgogICAgICB0eXBlOiBvYmplY3QKICAgICAgcmVxdWlyZWQ6CiAgICAgICAgLSBjb2RlCiAgICAgICAgLSBkZXNjcmlwdGlvbgogICAgICAgIC0gbWVzc2FnZQogICAgICAgIC0gc291cmNlCiAgICAgICAgLSB0eXBlCiAgICAgIHByb3BlcnRpZXM6CiAgICAgICAgY29kZToKICAgICAgICAgIHR5cGU6IG51bWJlcgogICAgICAgICAgZGVzY3JpcHRpb246IDUgZGlnaXQgZXJyb3IgbWVzc2FnZSBjb2RlCiAgICAgICAgICBleGFtcGxlOiAxMDAwMAogICAgICAgICAgZW51bToKICAgICAgICAgICAgLSAxMDAwMAogICAgICAgIGRlc2NyaXB0aW9uOgogICAgICAgICAgdHlwZTogc3RyaW5nCiAgICAgICAgICBkZXNjcmlwdGlvbjogRGVzY3JpcHRpb24gZm9yIHRoZSA1IGRpZ2l0ICBtZXNzYWdlIGNvZGUuCiAgICAgICAgICBleGFtcGxlOiBSZXF1aXJlZCBmaWVsZHMgYXJlIG1pc3Npbmcgb3IgaW52YWxpZCBkYXRhIHNwZWNpZmllZCBpbiB0aGUgcmVxdWVzdC4KICAgICAgICAgICAgUGxlYXNlIHJlZmVyIHRvIHRoZSBBUEkgZG9jdW1lbnRhdGlvbiBmb3IgbW9yZSBkZXRhaWxzLgogICAgICAgIHNvdXJjZToKICAgICAgICAgIHR5cGU6IHN0cmluZwogICAgICAgICAgZGVzY3JpcHRpb246IFNvdXJjZSBvZiB0aGUgbWVzc2FnZQogICAgICAgICAgZXhhbXBsZTogTWlkZGxld2FyZQogICAgICAgICAgZW51bToKICAgICAgICAgICAgLSBCYWNrZW5kCiAgICAgICAgICAgIC0gTWlkZGxld2FyZQogICAgICAgIG1lc3NhZ2U6CiAgICAgICAgICB0eXBlOiBzdHJpbmcKICAgICAgICAgIGRlc2NyaXB0aW9uOiBBbnkgbWVzc2FnZSBmb3IgdGhlIGNvbnN1bWluZyBzeXN0ZW0gZm9yIHVzZSBpbiBVSSBvciBpbiB0aGUKICAgICAgICAgICAgYXBwbGljYXRpb24KICAgICAgICAgIGV4YW1wbGU6IEludmFsaWQgSlNPTgogICAgICAgIHR5cGU6CiAgICAgICAgICB0eXBlOiBzdHJpbmcKICAgICAgICAgIGRlc2NyaXB0aW9uOiBUeXBlIG9mIHRoZSBtZXNzYWdlCiAgICAgICAgICBleGFtcGxlOiBWYWxpZGF0aW9uCiAgICAgICAgICBlbnVtOgogICAgICAgICAgICAtIFN5c3RlbQogICAgICAgICAgICAtIEJ1c2luZXNzCiAgICAgICAgICAgIC0gVmFsaWRhdGlvbgogICAgRXJyb3I0MDE6CiAgICAgIHR5cGU6IG9iamVjdAogICAgICByZXF1aXJlZDoKICAgICAgICAtIG1lc3NhZ2UKICAgICAgICAtIGh0dHBfc3RhdHVzX2NvZGUKICAgICAgcHJvcGVydGllczoKICAgICAgICBtZXNzYWdlOgogICAgICAgICAgdHlwZTogc3RyaW5nCiAgICAgICAgICBkZXNjcmlwdGlvbjogQW55IG1lc3NhZ2UgZm9yIHRoZSBjb25zdW1pbmcgc3lzdGVtIGZvciB1c2UgaW4gVUkgb3IgaW4gdGhlCiAgICAgICAgICAgIGFwcGxpY2F0aW9uCiAgICAgICAgICBleGFtcGxlOiBVbmF1dGhvcml6ZWQgLSBFeHBpcmVkIFRva2VuLgogICAgICAgIGh0dHBfc3RhdHVzX2NvZGU6CiAgICAgICAgICB0eXBlOiBzdHJpbmcKICAgICAgICAgIGRlc2NyaXB0aW9uOiBIVFRQIHJlc3BvbnNlIGNvZGUKICAgICAgICAgIGV4YW1wbGU6ICI0MDEiCiAgICBFcnJvcjQwMzoKICAgICAgdHlwZTogb2JqZWN0CiAgICAgIHJlcXVpcmVkOgogICAgICAgIC0gbWVzc2FnZQogICAgICAgIC0gaHR0cF9zdGF0dXNfY29kZQogICAgICBwcm9wZXJ0aWVzOgogICAgICAgIG1lc3NhZ2U6CiAgICAgICAgICB0eXBlOiBzdHJpbmcKICAgICAgICAgIGRlc2NyaXB0aW9uOiBBbnkgbWVzc2FnZSBmb3IgdGhlIGNvbnN1bWluZyBzeXN0ZW0gZm9yIHVzZSBpbiBVSSBvciBpbiB0aGUKICAgICAgICAgICAgYXBwbGljYXRpb24KICAgICAgICAgIGV4YW1wbGU6IEFQSSBLZXkgaXMgbm90IHZhbGlkIG9yIGlzIGV4cGlyZWQgLyByZXZva2VkLgogICAgICAgIGh0dHBfc3RhdHVzX2NvZGU6CiAgICAgICAgICB0eXBlOiBzdHJpbmcKICAgICAgICAgIGRlc2NyaXB0aW9uOiBIVFRQIHJlc3BvbnNlIGNvZGUKICAgICAgICAgIGV4YW1wbGU6ICI0MDMiCiAgICBFcnJvcjUwMDoKICAgICAgdHlwZTogb2JqZWN0CiAgICAgIHJlcXVpcmVkOgogICAgICAgIC0gY29kZQogICAgICAgIC0gZGVzY3JpcHRpb24KICAgICAgICAtIG1lc3NhZ2UKICAgICAgICAtIHNvdXJjZQogICAgICAgIC0gdHlwZQogICAgICBwcm9wZXJ0aWVzOgogICAgICAgIGNvZGU6CiAgICAgICAgICB0eXBlOiBudW1iZXIKICAgICAgICAgIGRlc2NyaXB0aW9uOiA1IGRpZ2l0ICBtZXNzYWdlIGNvZGUKICAgICAgICAgIGV4YW1wbGU6IDIwMDAwCiAgICAgICAgICBlbnVtOgogICAgICAgICAgICAtIDIwMDAwCiAgICAgICAgZGVzY3JpcHRpb246CiAgICAgICAgICB0eXBlOiBzdHJpbmcKICAgICAgICAgIGRlc2NyaXB0aW9uOiBEZXNjcmlwdGlvbiBmb3IgdGhlIDUgZGlnaXQgIG1lc3NhZ2UgY29kZS4KICAgICAgICAgIGV4YW1wbGU6IEludGVybmFsIFNlcnZlciBFcnJvcgogICAgICAgIHNvdXJjZToKICAgICAgICAgIHR5cGU6IHN0cmluZwogICAgICAgICAgZGVzY3JpcHRpb246IFNvdXJjZSBvZiB0aGUgbWVzc2FnZQogICAgICAgICAgZXhhbXBsZTogQmFja2VuZAogICAgICAgICAgZW51bToKICAgICAgICAgICAgLSBCYWNrZW5kCiAgICAgICAgICAgIC0gTWlkZGxld2FyZQogICAgICAgIG1lc3NhZ2U6CiAgICAgICAgICB0eXBlOiBzdHJpbmcKICAgICAgICAgIGRlc2NyaXB0aW9uOiBBbnkgbWVzc2FnZSBmb3IgdGhlIGNvbnN1bWluZyBzeXN0ZW0gZm9yIHVzZSBpbiBVSSBvciBpbiB0aGUKICAgICAgICAgICAgYXBwbGljYXRpb24KICAgICAgICB0eXBlOgogICAgICAgICAgdHlwZTogc3RyaW5nCiAgICAgICAgICBkZXNjcmlwdGlvbjogVHlwZSBvZiB0aGUgbWVzc2FnZQogICAgICAgICAgZXhhbXBsZTogU3lzdGVtCiAgICAgICAgICBlbnVtOgogICAgICAgICAgICAtIFN5c3RlbQogICAgICAgICAgICAtIEJ1c2luZXNzCiAgICAgICAgICAgIC0gVmFsaWRhdGlvbgogIHBhcmFtZXRlcnM6CiAgICBBdXRob3JpemF0aW9uSGVhZGVyOgogICAgICBuYW1lOiBBdXRob3JpemF0aW9uCiAgICAgIGluOiBoZWFkZXIKICAgICAgcmVxdWlyZWQ6IHRydWUKICAgICAgc2NoZW1hOgogICAgICAgIHR5cGU6IHN0cmluZwogICAgICAgIGRlc2NyaXB0aW9uOiBCZWFyZXIgdG9rZW4gZm9yIGF1dGhlbnRpY2F0aW9uCiAgICBDb250ZW50VHlwZUhlYWRlcjoKICAgICAgbmFtZTogQ29udGVudC1UeXBlCiAgICAgIGluOiBoZWFkZXIKICAgICAgcmVxdWlyZWQ6IHRydWUKICAgICAgc2NoZW1hOgogICAgICAgIHR5cGU6IHN0cmluZwogICAgICAgIGRlZmF1bHQ6IGFwcGxpY2F0aW9uL2pzb24KICAgICAgICBlbnVtOgogICAgICAgICAgLSBhcHBsaWNhdGlvbi9qc29uCiAgICAgICAgICAtIGFwcGxpY2F0aW9uL3htbAogICAgQ29ycmVsYXRpb25JZEhlYWRlcjoKICAgICAgbmFtZTogeC11b3MtY29ycmVsYXRpb24taWQKICAgICAgaW46IGhlYWRlcgogICAgICByZXF1aXJlZDogdHJ1ZQogICAgICBzY2hlbWE6CiAgICAgICAgdHlwZTogc3RyaW5nCiAgICAgICAgZGVzY3JpcHRpb246IEEgdW5pcXVlIGlkZW50aWZpZXIgdXNlZCBieSBjb25zdW1lcnMgb3Igd2l0aGluIHRoZSBtaWNyb3NlcnZpY2VzCiAgICAgICAgICBsYXllciBpbiBhIGJ1c2luZXNzIHByb2Nlc3Mgam91cm5leS4KICAgIFJlcXVlc3RJZEhlYWRlcjoKICAgICAgbmFtZTogeC11b3MtcmVxdWVzdC1pZAogICAgICBpbjogaGVhZGVyCiAgICAgIHJlcXVpcmVkOiB0cnVlCiAgICAgIHNjaGVtYToKICAgICAgICB0eXBlOiBzdHJpbmcKICAgICAgICBkZXNjcmlwdGlvbjogQSB1bmlxdWUgaWRlbnRpZmllciBmb3IgdGhlIEFQSSByZXF1ZXN0LgogICAgVGltZXN0YW1wSGVhZGVyOgogICAgICBuYW1lOiB4LXVvcy10aW1lc3RhbXAKICAgICAgaW46IGhlYWRlcgogICAgICByZXF1aXJlZDogdHJ1ZQogICAgICBzY2hlbWE6CiAgICAgICAgdHlwZTogc3RyaW5nCiAgICAgICAgZGVzY3JpcHRpb246IFRpbWVzdGFtcCBmb3Igd2hlbiB0aGUgQVBJIHJlcXVlc3Qgd2FzIG1hZGUuCiAgICAgICAgZm9ybWF0OiBkYXRlLXRpbWUKICAgIFRlc3RIZWFkZXI6CiAgICAgIG5hbWU6IHgtdW9zLXRlc3QKICAgICAgaW46IGhlYWRlcgogICAgICByZXF1aXJlZDogdHJ1ZQogICAgICBzY2hlbWE6CiAgICAgICAgdHlwZTogc3RyaW5nCiAgICAgICAgZGVzY3JpcHRpb246IEluZGljYXRlcyB3aGV0aGVyIHRoZSBBUEkgcmVxdWVzdCBpcyBhIHRlc3Qgb3IgYSBsaXZlIHJlcXVlc3QuCiAgICAgICAgZW51bToKICAgICAgICAgIC0gdGVzdAogICAgICAgICAgLSBsaXZlCiAgICAgICAgICAtIHNhbmRib3gKICAgICAgICAgIC0gcHJvZHVjdGlvbgogIHNlY3VyaXR5U2NoZW1lczoKICAgIGJlYXJlckF1dGg6CiAgICAgIHR5cGU6IG9hdXRoMgogICAgICBmbG93czoKICAgICAgICBpbXBsaWNpdDoKICAgICAgICAgIGF1dGhvcml6YXRpb25Vcmw6IGh0dHBzOi8vZXhhbXBsZS5jb20vb2F1dGgyL2F1dGhvcml6ZQogICAgICAgICAgc2NvcGVzOgogICAgICAgICAgICB1b3Mvc3R1ZGVudC1yZWFkOiBSZWFkIHN0dWRlbnQgaW5mb3JtYXRpb24KICAgICAgICAgICAgdW9zL3N0dWRlbnQtcmVhZC1hbGw6IFJlYWQgYWxsIHN0dWRlbnQgaW5mb3JtYXRpb24KICAgIGFwaUtleToKICAgICAgdHlwZTogYXBpS2V5CiAgICAgIGluOiBoZWFkZXIKICAgICAgbmFtZTogeC1hcGkta2V5Cg=="
                  }"
