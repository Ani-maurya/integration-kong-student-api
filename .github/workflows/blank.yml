name: Kong API Gateway Workflow  

on:
  push:
    branches:
      - main

jobs:

  OAS_TO_Kong:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      # - name: Install Insomnia CLI
      #   run: |
      #     wget https://github.com/Kong/insomnia/releases/download/lib%408.6.1/inso-linux-8.6.1.tar.xz
      #     tar -xf inso-linux-8.6.1.tar.xz

      # - name: Lint OpenAPI Spec
      #   run: |
      #     ./inso lint spec test.yaml 

      # - name: Generate kong.yaml
      #   run: ./inso generate config test.yaml --type declarative -o kong.yaml

      - name: install deck CLI
        run: |
          curl -sL https://github.com/kong/deck/releases/download/v1.34.0/deck_1.34.0_linux_amd64.tar.gz -o deck.tar.gz
          tar -xf deck.tar.gz -C /tmp 
          sudo cp /tmp/deck /usr/local/bin/

      # - name: update
      #   run: deck convert --from kong-gateway-2.x --to kong-gateway-3.x --input-file kong.yaml --output-file new-kong.yaml

      # - name: download jq
      #   run: |
      #     sudo apt install jq -y
      #     jq --version

      # - name: download yq
      #   run: |
      #     sudo snap install yq
      #     yq --version

      - name: Set headers and run deck sync
        run: |  
              # cat new-kong.yaml
              deck file openapi2kong -s test.yaml --select-tag=dev -o kong.yaml
              deck sync  --select-tag dev -s kong.yaml --konnect-token spat_cbdDxuiAWLhjGVnKneiSOxz10au8pPqKmx6hL22cgNtheJLeA --konnect-control-plane-name Transit-testing

      
  publish-customer-api-to-portal:  # Publish the API to the dev portal
  
    name: Publish OAS to dev portal

    needs: OAS_TO_Kong   # Make sure the completed before running this job

    runs-on: ubuntu-latest  # Use Ubuntu as the operating system for the job

    steps:

      
       - name: Set environment variables
         id: set_env_vars
         run: |
          echo "API_PRODUCT_NAME=test-product" >> $GITHUB_ENV
          echo "CONTROL_PLANE_NAME=KS-Cp-konnect" >> $GITHUB_ENV
          echo "GATEWAY_SERVICE_NAME=test-admin-api-portal" >> $GITHUB_ENV

       - name: Create API product
         id: create_api_product
         run: |
          response=$(curl --request POST \
            --url https://us.api.konghq.com/v2/api-products \
            --header 'Authorization: Bearer spat_cbdDxuiAWLhjGVnKneiSOxz10au8pPqKmx6hL22cgNtheJLeA' \
            --header 'Content-Type: application/json' \
            --data '{
              "name": "${{ env.API_PRODUCT_NAME }}",
              "description": "Creating through admin api",
              "labels": {}
            }')

          api_product_id=$(echo $response | jq -r '.id')
          echo "API Product ID: $api_product_id"
          echo "::set-output name=api_product_id::$api_product_id"

       - name: Get Dev Portal ID
         id: get_dev_portal_id
         run: |
          Dev_portal_id=$(curl --request GET   --url https://us.api.konghq.com/v2/portals   --header 'Authorization: Bearer spat_cbdDxuiAWLhjGVnKneiSOxz10au8pPqKmx6hL22cgNtheJLeA' | jq .data[].id)
          echo "Dev Portal ID: $Dev_portal_id"
          echo "::set-output name=Dev_portal_id::$Dev_portal_id"

       - name: Create the product version
         run: |
          api_product_version_id=$(curl --request POST \
            --url https://us.api.konghq.com/v2/api-products/$api_product_id/product-versions \
            --header 'Authorization: Bearer spat_cbdDxuiAWLhjGVnKneiSOxz10au8pPqKmx6hL22cgNtheJLeA' \
            --header 'Content-Type: application/json' \
            --data '{
              "name": "v1",
              "publish_status": "published",
              "gateway_service": null
            }' | jq -r '.id')

          echo "API Product Version ID: $api_product_version_id"
          echo "::set-output name=api_product_version_id::$api_product_version_id"

       - name: Get Control Plane ID
         run: |
          control_plane_id=$(curl --location 'https://us.api.konghq.com/v2/control-planes/' --header 'Authorization: spat_cbdDxuiAWLhjGVnKneiSOxz10au8pPqKmx6hL22cgNtheJLeA' | jq -r '.data[] | select(.name == "${{ env.CONTROL_PLANE_NAME }}") | .id')
          echo "Control Plane ID: $control_plane_id"

       - name: Get Service ID
         run: |
          service_id=$(curl --request GET   --url https://us.api.konghq.com/v2/control-planes/$control_plane_id/core-entities/services   --header 'Authorization: spat_cbdDxuiAWLhjGVnKneiSOxz10au8pPqKmx6hL22cgNtheJLeA' | jq -r '.data[] | select(.name == "${{ env.GATEWAY_SERVICE_NAME }}") | .id')
          echo "Gateway Service ID: $service_id"

       - name: Link service to the product version
         run: |
          curl --request PATCH \
            --url https://us.api.konghq.com/v2/api-products/$api_product_id/product-versions/$api_product_version_id \
            --header 'Authorization: Bearer spat_cbdDxuiAWLhjGVnKneiSOxz10au8pPqKmx6hL22cgNtheJLeA' \
            --header 'Content-Type: application/json' \
            --data '{
              "name": "v1",
              "publish_status": "published",
              "deprecated": false,
              "notify": true,
              "gateway_service": {
                "control_plane_id": "$control_plane_id",
                "id": "$service_id"
              }
            }'

       - name: Upload spec on the version
         run: |
          curl --request POST \
            --url https://us.api.konghq.com/v2/api-products/$api_product_id/product-versions/$api_product_version_id/specifications \
            --header 'Authorization: Bearer spat_cbdDxuiAWLhjGVnKneiSOxz10au8pPqKmx6hL22cgNtheJLeA' \
            --header 'Content-Type: application/json' \
            --data '{
              "name": "test.yaml",
              "content": "TXkgWUFNTCBvciBKU09OIGZvcm1hdHRlZCBPQVMgY29udGVudA=="
            }'
    
  
  
          

        

   
        
   
         
    
         

     



    

        

   
        
   
         
    
         

     
